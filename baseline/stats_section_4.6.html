<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Section 4.6 Statistical Methods &mdash; CytoAtlas Reports</title>
<style>
    :root {
        --bg: #ffffff;
        --fg: #1a1a2e;
        --accent: #2563eb;
        --accent-hover: #1d4ed8;
        --card-bg: #f8fafc;
        --card-border: #e2e8f0;
        --muted: #64748b;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        color: var(--fg);
        background: var(--bg);
        line-height: 1.6;
    }
    header {
        border-bottom: 1px solid var(--card-border);
        padding: 2rem 1.5rem 1.5rem;
        max-width: 960px;
        margin: 0 auto;
    }
    header h1 { font-size: 1.8rem; font-weight: 700; }
    header p { color: var(--muted); margin-top: 0.25rem; }
    main {
        max-width: 960px;
        margin: 0 auto;
        padding: 2rem 1.5rem 4rem;
    }
    footer {
        max-width: 960px;
        margin: 0 auto;
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--card-border);
        font-size: 0.8rem;
        color: var(--muted);
    }

    /* Navigation */
    .back-link {
        display: inline-block;
        margin-bottom: 1.5rem;
        padding: 0.35em 0.75em;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 6px;
        font-size: 0.85rem;
        color: var(--accent);
        text-decoration: none;
        transition: border-color 0.15s;
    }
    .back-link:hover { border-color: var(--accent); }

    /* Headings */
    h2 {
        font-size: 1.4rem;
        margin: 2.5rem 0 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--accent);
    }
    h3 { font-size: 1.1rem; margin: 1.5rem 0 0.6rem; color: var(--accent); }
    h4 { font-size: 1rem; margin: 1.25rem 0 0.5rem; color: var(--fg); }
    p { margin-bottom: 0.75rem; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Tables */
    table { width: 100%; border-collapse: collapse; margin: 1rem 0 1.25rem; font-size: 0.875rem; }
    th, td { padding: 0.6rem 0.85rem; text-align: left; border: 1px solid var(--card-border); }
    th { background: var(--card-bg); font-weight: 600; }
    tr:hover { background: var(--card-bg); }

    /* Code */
    code {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        padding: 0.15em 0.4em;
        border-radius: 4px;
        font-size: 0.85rem;
        font-family: 'JetBrains Mono', 'Fira Code', ui-monospace, monospace;
    }

    /* Significance markers */
    .sig { font-weight: bold; }
    .sig-yes { color: #059669; }
    .sig-no { color: var(--muted); }

    /* Lists */
    ul, ol { margin: 0.5rem 0 1rem 1.5rem; }
    li { margin-bottom: 0.4rem; }

    .page-title {
        font-size: 1.6rem;
        font-weight: 700;
        margin-top: 0;
        margin-bottom: 1.5rem;
    }
</style>
</head>
<body>

<header>
    <h1>CytoAtlas Reports</h1>
    <p>Pan-Disease Single-Cell Cytokine Activity Atlas &mdash; reporting hub</p>
</header>

<main>

<a href="index.html" class="back-link">&larr; Back to report</a>

<div class="page-title">Section 4.6: Effect of Aggregation Level &mdash; Statistical Methods</div>

<h2>Overview</h2>
<p>Section 4.6 examines how the CytoSig vs SecAct comparison changes across aggregation levels (from coarse donor-level to fine cell-type-level pseudobulk). Two statistical tests are applied at <strong>each aggregation level within each atlas</strong>, presented in two tabs:</p>
<ul>
<li><strong>Total tab:</strong> CytoSig (all ~43 targets) vs SecAct (all ~1,170 targets) &mdash; Mann&ndash;Whitney U test (unpaired, unequal n).</li>
<li><strong>Matched tab:</strong> CytoSig vs SecAct restricted to 32 shared targets (22 direct + 10 alias-resolved) &mdash; Wilcoxon signed-rank test (paired).</li>
</ul>
<p>Four atlases have multiple aggregation levels: CIMA (5 levels), Inflammation Main (3 levels), scAtlas Normal (3 levels), and scAtlas Cancer (3 levels). GTEx and TCGA have only donor-level data and are not included.</p>

<h2>Multiple Testing Correction</h2>
<p>Within each atlas, multiple aggregation levels are tested simultaneously. To control the false discovery rate, <strong>Benjamini&ndash;Hochberg (BH) FDR correction</strong> is applied across all levels within each atlas, separately for each test type (Mann&ndash;Whitney U and Wilcoxon signed-rank).</p>
<ul>
<li><strong>CIMA:</strong> 5 tests corrected together (Donor Only, Donor&times;L1, Donor&times;L2, Donor&times;L3, Donor&times;L4)</li>
<li><strong>Inflammation Main:</strong> 3 tests corrected together (Donor Only, Donor&times;L1, Donor&times;L2)</li>
<li><strong>scAtlas Normal:</strong> 3 tests corrected together</li>
<li><strong>scAtlas Cancer:</strong> 3 tests corrected together</li>
</ul>
<p>Significance annotations in the interactive figure use <strong>BH-corrected q-values</strong>, not raw p-values. Implementation: <code>statsmodels.stats.multitest.multipletests(pvals, method='fdr_bh')</code>.</p>

<h2>How &rho; values are generated at each level</h2>
<p>At each aggregation level, pseudobulk gene expression profiles are computed by averaging single-cell data within each (donor &times; cell-type group). For each target gene, a Spearman rank correlation (&rho;) is computed between predicted cytokine activity and target gene expression across all pseudobulk profiles at that level.</p>
<p>At coarser levels (e.g., donor only), each target has fewer &rho; values (one per donor grouping). At finer levels (e.g., donor &times; cell type), each target has more &rho; values (one per donor &times; cell-type combination), but each based on fewer cells.</p>

<h2>Total Comparison (Mann&ndash;Whitney U Test)</h2>

<h3>Rationale</h3>
<p>The Mann&ndash;Whitney U test compares the full &rho; distributions of CytoSig (all ~43 targets) vs SecAct (all ~1,170 targets). The two target sets are <strong>independent with unequal sample sizes</strong>.</p>

<h3>Procedure</h3>
<ol>
<li>For each atlas and each aggregation level, collect all Spearman &rho; values for CytoSig targets and all &rho; values for SecAct targets at that level.</li>
<li>At finer levels, each target contributes multiple &rho; values (one per cell-type group), so the total sample size grows.</li>
<li>Apply the two-sided Mann&ndash;Whitney U test (<code>scipy.stats.mannwhitneyu</code>, <code>alternative='two-sided'</code>).</li>
<li>Apply BH-FDR correction across all levels within each atlas.</li>
</ol>

<h3>Results</h3>

<h4>CIMA (5 levels, BH-FDR across 5 tests)</h4>
<table>
<tr><th>Level</th><th>n<sub>CS</sub></th><th>n<sub>SA</sub></th><th>Median &rho;<sub>CS</sub></th><th>Median &rho;<sub>SA</sub></th><th>p<sub>raw</sub></th><th>q<sub>BH</sub></th><th>Sig.</th></tr>
<tr><td>Donor Only</td><td>43</td><td>1,161</td><td>0.114</td><td>0.191</td><td>3.18 &times; 10<sup>&minus;2</sup></td><td>3.18 &times; 10<sup>&minus;2</sup></td><td class="sig sig-yes">*</td></tr>
<tr><td>Donor &times; L1</td><td>301</td><td>8,125</td><td>0.062</td><td>0.130</td><td>&lt; 10<sup>&minus;8</sup></td><td>&lt; 10<sup>&minus;8</sup></td><td class="sig sig-yes">***</td></tr>
<tr><td>Donor &times; L2</td><td>1,156</td><td>31,346</td><td>0.017</td><td>0.073</td><td>&lt; 10<sup>&minus;38</sup></td><td>&lt; 10<sup>&minus;38</sup></td><td class="sig sig-yes">***</td></tr>
<tr><td>Donor &times; L3</td><td>1,602</td><td>43,520</td><td>0.011</td><td>0.066</td><td>&lt; 10<sup>&minus;59</sup></td><td>&lt; 10<sup>&minus;59</sup></td><td class="sig sig-yes">***</td></tr>
<tr><td>Donor &times; L4</td><td>2,914</td><td>78,739</td><td>0.005</td><td>0.052</td><td>&lt; 10<sup>&minus;96</sup></td><td>&lt; 10<sup>&minus;96</sup></td><td class="sig sig-yes">***</td></tr>
</table>

<h4>Inflammation Main (3 levels, BH-FDR across 3 tests)</h4>
<table>
<tr><th>Level</th><th>n<sub>CS</sub></th><th>n<sub>SA</sub></th><th>Median &rho;<sub>CS</sub></th><th>Median &rho;<sub>SA</sub></th><th>p<sub>raw</sub></th><th>q<sub>BH</sub></th><th>Sig.</th></tr>
<tr><td>Donor Only</td><td>33</td><td>805</td><td>0.323</td><td>0.173</td><td>0.548</td><td>0.716</td><td class="sig sig-no">ns</td></tr>
<tr><td>Donor &times; L1</td><td>514</td><td>12,666</td><td>0.068</td><td>0.080</td><td>0.693</td><td>0.716</td><td class="sig sig-no">ns</td></tr>
<tr><td>Donor &times; L2</td><td>1,882</td><td>46,878</td><td>0.044</td><td>0.048</td><td>0.716</td><td>0.716</td><td class="sig sig-no">ns</td></tr>
</table>

<h4>scAtlas Normal (3 levels, BH-FDR across 3 tests)</h4>
<table>
<tr><th>Level</th><th>n<sub>CS</sub></th><th>n<sub>SA</sub></th><th>Median &rho;<sub>CS</sub></th><th>Median &rho;<sub>SA</sub></th><th>p<sub>raw</sub></th><th>q<sub>BH</sub></th><th>Sig.</th></tr>
<tr><td>Donor &times; Organ</td><td>819</td><td>21,869</td><td>0.150</td><td>0.295</td><td>&lt; 10<sup>&minus;30</sup></td><td>&lt; 10<sup>&minus;30</sup></td><td class="sig sig-yes">***</td></tr>
<tr><td>Donor &times; Organ &times; CT1</td><td>3,980</td><td>107,301</td><td>0.085</td><td>0.171</td><td>&lt; 10<sup>&minus;60</sup></td><td>&lt; 10<sup>&minus;60</sup></td><td class="sig sig-yes">***</td></tr>
<tr><td>Donor &times; Organ &times; CT2</td><td>7,095</td><td>191,265</td><td>0.059</td><td>0.129</td><td>&lt; 10<sup>&minus;63</sup></td><td>&lt; 10<sup>&minus;63</sup></td><td class="sig sig-yes">***</td></tr>
</table>

<h4>scAtlas Cancer (3 levels, BH-FDR across 3 tests)</h4>
<table>
<tr><th>Level</th><th>n<sub>CS</sub></th><th>n<sub>SA</sub></th><th>Median &rho;<sub>CS</sub></th><th>Median &rho;<sub>SA</sub></th><th>p<sub>raw</sub></th><th>q<sub>BH</sub></th><th>Sig.</th></tr>
<tr><td>Tumor Only</td><td>43</td><td>1,140</td><td>0.184</td><td>0.399</td><td>1.1 &times; 10<sup>&minus;5</sup></td><td>1.1 &times; 10<sup>&minus;5</sup></td><td class="sig sig-yes">***</td></tr>
<tr><td>Tumor &times; Cancer</td><td>706</td><td>18,892</td><td>0.223</td><td>0.368</td><td>&lt; 10<sup>&minus;30</sup></td><td>&lt; 10<sup>&minus;30</sup></td><td class="sig sig-yes">***</td></tr>
<tr><td>Tumor &times; Cancer &times; CT1</td><td>3,586</td><td>98,021</td><td>0.033</td><td>0.171</td><td>&lt; 10<sup>&minus;100</sup></td><td>&lt; 10<sup>&minus;100</sup></td><td class="sig sig-yes">***</td></tr>
</table>

<h2>Matched Comparison (Wilcoxon Signed-Rank Test)</h2>

<h3>Rationale</h3>
<p>Restricts to the 32 shared targets (after alias resolution) between CytoSig and SecAct. Each target serves as its own control in a <strong>paired design</strong>.</p>

<h3>The 32 shared targets (after alias resolution)</h3>
<p><strong>22 direct matches</strong> (CytoSig target name identical to SecAct target name): BDNF, BMP2, BMP4, BMP6, CXCL12, FGF2, GDF11, HGF, IFNG, IL10, IL15, IL1A, IL1B, IL21, IL27, IL6, LIF, LTA, OSM, TGFB1, TGFB3, VEGFA</p>
<p><strong>10 alias matches</strong> (CytoSig name &rarr; resolved gene symbol in SecAct): Activin A &rarr; INHBA, CD40L &rarr; CD40LG, GCSF &rarr; CSF3, GMCSF &rarr; CSF2, IFNL &rarr; IFNL1, IL36 &rarr; IL36A, MCSF &rarr; CSF1, TNFA &rarr; TNF, TRAIL &rarr; TNFSF10, TWEAK &rarr; TNFSF12</p>

<h3>Procedure</h3>
<ol>
<li>For each atlas and each aggregation level, collect the Spearman &rho; for each of the 32 shared targets in both CytoSig and SecAct.</li>
<li>At finer levels, each target produces multiple &rho; values (one per cell-type group). These are <strong>averaged (median) per target</strong> to yield one representative &rho; per target, ensuring the paired test&rsquo;s independence assumption is met.</li>
<li>Pair CytoSig and SecAct &rho; values by target (after alias resolution). Apply the two-sided Wilcoxon signed-rank test (<code>scipy.stats.wilcoxon</code>, <code>alternative='two-sided'</code>).</li>
<li>Apply BH-FDR correction across all levels within each atlas.</li>
</ol>

<h3>Why median-aggregate before pairing?</h3>
<p>At finer aggregation levels, each target produces multiple &rho; values (e.g., 7 cell types in CIMA L1, or 25 organs in scAtlas Normal). These within-target observations are <strong>not independent</strong> &mdash; they share the same underlying biological signal for that target. Taking the median first collapses these correlated observations into a single representative &rho; per target, ensuring the Wilcoxon test&rsquo;s independence assumption is met.</p>

<h3>Results</h3>

<h4>CIMA (5 levels, BH-FDR across 5 tests)</h4>
<table>
<tr><th>Level</th><th>n<sub>pairs</sub></th><th>Median &rho;<sub>CS</sub></th><th>Median &rho;<sub>SA</sub></th><th>p<sub>raw</sub></th><th>q<sub>BH</sub></th><th>Sig.</th></tr>
<tr><td>Donor Only</td><td>32</td><td>0.173</td><td>0.302</td><td>2.28 &times; 10<sup>&minus;2</sup></td><td>5.70 &times; 10<sup>&minus;2</sup></td><td class="sig sig-no">ns</td></tr>
<tr><td>Donor &times; L1</td><td>32</td><td>0.087</td><td>0.164</td><td>2.28 &times; 10<sup>&minus;2</sup></td><td>5.70 &times; 10<sup>&minus;2</sup></td><td class="sig sig-no">ns</td></tr>
<tr><td>Donor &times; L2</td><td>32</td><td>0.039</td><td>0.079</td><td>5.95 &times; 10<sup>&minus;2</sup></td><td>9.92 &times; 10<sup>&minus;2</sup></td><td class="sig sig-no">ns</td></tr>
<tr><td>Donor &times; L3</td><td>32</td><td>0.027</td><td>0.053</td><td>9.84 &times; 10<sup>&minus;2</sup></td><td>1.23 &times; 10<sup>&minus;1</sup></td><td class="sig sig-no">ns</td></tr>
<tr><td>Donor &times; L4</td><td>32</td><td>0.014</td><td>0.019</td><td>1.66 &times; 10<sup>&minus;1</sup></td><td>1.66 &times; 10<sup>&minus;1</sup></td><td class="sig sig-no">ns</td></tr>
</table>

<h4>Inflammation Main (3 levels, BH-FDR across 3 tests)</h4>
<table>
<tr><th>Level</th><th>n<sub>pairs</sub></th><th>Median &rho;<sub>CS</sub></th><th>Median &rho;<sub>SA</sub></th><th>p<sub>raw</sub></th><th>q<sub>BH</sub></th><th>Sig.</th></tr>
<tr><td>Donor Only</td><td>27</td><td>0.352</td><td>0.438</td><td>1.41 &times; 10<sup>&minus;1</sup></td><td>4.24 &times; 10<sup>&minus;1</sup></td><td class="sig sig-no">ns</td></tr>
<tr><td>Donor &times; L1</td><td>27</td><td>0.111</td><td>0.136</td><td>4.70 &times; 10<sup>&minus;1</sup></td><td>4.70 &times; 10<sup>&minus;1</sup></td><td class="sig sig-no">ns</td></tr>
<tr><td>Donor &times; L2</td><td>27</td><td>0.097</td><td>0.086</td><td>3.01 &times; 10<sup>&minus;1</sup></td><td>4.52 &times; 10<sup>&minus;1</sup></td><td class="sig sig-no">ns</td></tr>
</table>

<h4>scAtlas Normal (3 levels, BH-FDR across 3 tests)</h4>
<table>
<tr><th>Level</th><th>n<sub>pairs</sub></th><th>Median &rho;<sub>CS</sub></th><th>Median &rho;<sub>SA</sub></th><th>p<sub>raw</sub></th><th>q<sub>BH</sub></th><th>Sig.</th></tr>
<tr><td>Donor &times; Organ</td><td>32</td><td>0.227</td><td>0.458</td><td>3.0 &times; 10<sup>&minus;6</sup></td><td>9.0 &times; 10<sup>&minus;6</sup></td><td class="sig sig-yes">***</td></tr>
<tr><td>Donor &times; Organ &times; CT1</td><td>32</td><td>0.114</td><td>0.196</td><td>3.5 &times; 10<sup>&minus;5</sup></td><td>5.3 &times; 10<sup>&minus;5</sup></td><td class="sig sig-yes">***</td></tr>
<tr><td>Donor &times; Organ &times; CT2</td><td>32</td><td>0.085</td><td>0.148</td><td>1.34 &times; 10<sup>&minus;4</sup></td><td>1.34 &times; 10<sup>&minus;4</sup></td><td class="sig sig-yes">***</td></tr>
</table>

<h4>scAtlas Cancer (3 levels, BH-FDR across 3 tests)</h4>
<table>
<tr><th>Level</th><th>n<sub>pairs</sub></th><th>Median &rho;<sub>CS</sub></th><th>Median &rho;<sub>SA</sub></th><th>p<sub>raw</sub></th><th>q<sub>BH</sub></th><th>Sig.</th></tr>
<tr><td>Tumor Only</td><td>32</td><td>0.291</td><td>0.505</td><td>3.5 &times; 10<sup>&minus;5</sup></td><td>4.9 &times; 10<sup>&minus;5</sup></td><td class="sig sig-yes">***</td></tr>
<tr><td>Tumor &times; Cancer</td><td>32</td><td>0.278</td><td>0.458</td><td>4.9 &times; 10<sup>&minus;5</sup></td><td>4.9 &times; 10<sup>&minus;5</sup></td><td class="sig sig-yes">***</td></tr>
<tr><td>Tumor &times; Cancer &times; CT1</td><td>32</td><td>0.047</td><td>0.154</td><td>4.0 &times; 10<sup>&minus;6</sup></td><td>1.2 &times; 10<sup>&minus;5</sup></td><td class="sig sig-yes">***</td></tr>
</table>

<h2>Boxplot visualization vs statistical test</h2>
<p>The boxplots in the &ldquo;Matched&rdquo; tab display the <strong>per-target median &rho; values</strong> for the 32 shared targets (one value per target, obtained by taking the median across cell-type groups at finer levels). The Wilcoxon test is applied to these same median-aggregated paired values.</p>

<h2>Significance Thresholds</h2>
<table>
<tr><th>Symbol</th><th>Threshold</th></tr>
<tr><td>***</td><td>q<sub>BH</sub> &lt; 0.001</td></tr>
<tr><td>**</td><td>q<sub>BH</sub> &lt; 0.01</td></tr>
<tr><td>*</td><td>q<sub>BH</sub> &lt; 0.05</td></tr>
<tr><td>ns</td><td>q<sub>BH</sub> &ge; 0.05 (not significant)</td></tr>
</table>

<h2>Software</h2>
<p>All tests computed using <code>scipy.stats</code> (Python). Mann&ndash;Whitney U: <code>scipy.stats.mannwhitneyu(cytosig_rhos, secact_rhos, alternative='two-sided')</code>. Wilcoxon signed-rank: <code>scipy.stats.wilcoxon(cytosig_medians, secact_medians, alternative='two-sided')</code> on per-target median-aggregated paired values. Multiple testing correction: <code>statsmodels.stats.multitest.multipletests(pvals, method='fdr_bh')</code> applied across levels within each atlas.</p>

</main>

<footer>
    CytoAtlas &mdash; generated reports are served via GitHub Pages
</footer>

</body>
</html>
